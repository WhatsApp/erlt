name: Erl1+ CI

on: [push]

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Set up JDK 1.8
        uses: actions/setup-java@v1
        with:
          java-version: 1.8
      - name: set environment variables
        run: |
          echo "::set-env name=CACHE_BIN::$GITHUB_WORKSPACE/.cache/bin"
          echo "::set-env name=PATH::$GITHUB_WORKSPACE/.cache/bin:$PATH"
          echo "::set-env name=OPAMROOT::$GITHUB_WORKSPACE/.cache/.opam"
      - name: Cache Opam
        id: cache-opam
        uses: actions/cache@v1
        with:
          path: .cache
          key: opam_ocaml.4.10.0_ocamlformat.0.14.1
      - name: install opam
        if: steps.cache-opam.outputs.cache-hit != 'true'
        run: |
          mkdir -p $CACHE_BIN
          cd $CACHE_BIN
          wget https://github.com/ocaml/opam/releases/download/2.0.6/opam-2.0.6-x86_64-linux
          mv opam-2.0.6-x86_64-linux opam
          chmod +x opam
      - name: install opam stuff
        if: steps.cache-opam.outputs.cache-hit != 'true'
        run: |
          sudo apt-get install bubblewrap
          opam init -c 4.10.0
          eval $(opam env)
          opam install ocamlformat.0.14.1 -y
          ocamlc --version
          ocamlformat --version
      - name: opam_env
        run:  echo "::set-env name=PATH::$GITHUB_WORKSPACE/.cache/.opam/4.10.0/bin/:$PATH"
      - name: Erlang version
        run:  "erl -eval 'erlang:display(erlang:system_info(otp_release)), halt().'  -noshell"
      - name: make project
        run:  make
      - name: build sterlang backend
        run:  cd sterlang; sbt assembly
      - name: "examples/dev/src: make"
        run:  make -C examples/dev/src
      - name: "examples/doc/src: make"
        run:  make -C examples/doc/src
      - name: "examples/elm-core/src: make"
        run:  make -C examples/elm-core/src
      - name: "examples/dev_dots/src: make"
        run:  make -C examples/dev_dots/src
      - name: "examples/dev_enum/src: make"
        run:  make -C examples/dev_enum/src
      - name: "examples/calc/src: make"
        run:  make -C examples/calc/src
      - name: "examples/dev/src: test-ir"
        run:  make test-ir -C examples/dev/src
      - name: "examples/doc/src: test-ir"
        run:  make test-ir -C examples/doc/src
      - name: "examples/elm-core/src: test-ir"
        run:  make test-ir -C examples/elm-core/src
      - name: "examples/dev_dots/src: test-ir"
        run:  make test-ir -C examples/dev_dots/src
      - name: "examples/dev_enum/src: test-ir"
        run:  make test-ir -C examples/dev_enum/src
      - name: "examples/calc/src: test-ir"
        run:  make test-ir -C examples/calc/src
      - name: "examples/dev_module_record/src: make"
        run:  make erl2c-records -C examples/dev_module_record/src
      - name: "examples/checks/src: test"
        run:  make test -C examples/checks/src
