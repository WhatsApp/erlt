DIRS := calc dev dev_enum dev_struct doc elm_core erltodo

build:
	../sbtn/dl.sh
	cd ../sterlang; ../sbtn/sbtn sterlangd
	ERL_FLAGS="-args_file dev.vm.args" rebar3 compile

clean:
	rm -rf _build

test-ir: $(DIRS:%=test-ir/%)

clean-ir:
	find _build -name build -delete || true

test-beam: $(DIRS:%=test-beam/%)

ir: clean-ir build

# The generated .erl files are not actually used in compilation
# but are there for humans to read. Not actually "ir"
test-ir/%: ir
	@# only include .erl files
	diff -r -x sterlang -x '*.defs' -x '*.etf' -x '*.D' -x 't_io.*' _build/default/lib/$*/build $*/ir-spec

# test `erlt --------> beam -> disassembly`
# matches `erlt -> erl -> beam -> disassembly`
test-beam/%: ir
	rm -rf _build/default/lib/$*/test_ouptput
	mkdir -p _build/default/lib/$*/test_output/from_erl
	mkdir -p _build/default/lib/$*/test_output/from_beam
	../test_util/disassemble.escript --beam _build/default/lib/$*/ebin _build/default/lib/$*/test_output/from_beam
	@# this is annoying hard-coding, but we need to exclude files generated by rebar's classic erlang and yrl+xrl compilers
	@# because they won't have corresponding .erls in the build directory. We'll need to do the same for beams generated from .erls in future
	rm -f _build/default/lib/$*/test_output/from_beam/*_lexer.dis _build/default/lib/$*/test_output/from_beam/*_parser.dis
	../test_util/disassemble.escript --erl _build/default/lib/$*/build _build/default/lib/$*/test_output/from_erl
	diff -r _build/default/lib/$*/test_output/from_beam _build/default/lib/$*/test_output/from_erl -x t_io.*

update-ir-spec/%: ir
	@rm -rf $*/ir-spec
	@mkdir $*/ir-spec
	cp _build/default/lib/$*/build/*.erl $*/ir-spec

update-ir-spec: $(DIRS:%=update-ir-spec/%)

test-others:
	# TODO: port to remote structs and re-enable
	# $(MAKE) -C dev_module_record/src erl2c-records
	$(MAKE) -C checks/src test

test-interop: build
	# test that we are not removing beams generated from classic rebar compilers
	@stat _build/default/lib/calc/ebin/calc_lexer.beam &> /dev/null
	@stat _build/default/lib/calc/ebin/calc_parser.beam &> /dev/null && echo ok

test: test-ir test-beam test-interop test-others

.PHONY: build clean ir test-ir update-ir-spec test-beam test-interop
